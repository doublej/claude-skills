{
  "title": "Render Layers",
  "content": "The PixiJS Layer API provides a powerful way to control the **rendering order** of objects independently of their **logical parent-child relationships** in the scene graph. With RenderLayers, you can decouple how objects are transformed (via their logical parent) from how they are visually drawn on the screen.\n\nUsing RenderLayers ensures these elements are visually prioritized while maintaining logical parent-child relationships. Examples include:\n\n- A character with a health bar: Ensure the health bar always appears on top of the world, even if the character moves behind an object.\n\n- UI elements like score counters or notifications: Keep them visible regardless of the game world’s complexity.\n\n- Highlighting Elements in Tutorials: Imagine a tutorial where you need to push back most game elements while highlighting a specific object. RenderLayers can split these visually. The highlighted object can be placed in a foreground layer to be rendered above a push back layer.\n\nThis guide explains the key concepts, provides practical examples, and highlights common gotchas to help you use the Layer API effectively.\n\n1. **Independent Rendering Order**:\n\n- RenderLayers allow control of the draw order independently of the logical hierarchy, ensuring objects are rendered in the desired order.\n\n2. **Logical Parenting Stays Intact**:\n\n- Objects maintain transformations (e.g., position, scale, rotation) from their logical parent, even when attached to RenderLayers.\n\n3. **Explicit Object Management**:\n\n- Objects must be manually reassigned to a layer after being removed from the scene graph or layer, ensuring deliberate control over rendering.\n\n4. **Dynamic Sorting**:\n\n- Within layers, objects can be dynamically reordered using `zIndex` and `sortChildren` for fine-grained control of rendering order.\n\n### **Basic API Usage**\n\nFirst lets create two items that we want to render, red guy and blue guy.\n\n![alt text](render-layers/image-1.png)\n\nNow we know that red guy will be rendered first, then blue guy. Now in this simple example you could get away with just sorting the `zIndex` of the red guy and blue guy to help reorder.\n\nBut this is a guide about render layers, so lets create one of those.\n\nUse `renderLayer.attach` to assign an object to a layer. This overrides the object’s default render order defined by its logical parent.\n\n![alt text](render-layers/image-2.png)\n\nSo now our scene graph order is:\n\nAnd our render order is:\n\nThis happens because the layer is now the last child in the stage. Since the red guy is attached to the layer, it will be rendered at the layer's position in the scene graph. However, it still logically remains in the same place in the scene hierarchy.\n\n#### **3. Removing Objects from a Layer**\n\nNow let's remove the red guy from the layer. To stop an object from being rendered in a layer, use `removeFromLayer`. Once removed from the layer, its still going to be in the scene graph, and will be rendered in its scene graph order.\n\n![alt text](render-layers/image-1.png)\n\nRemoving an object from its logical parent (`removeChild`) automatically removes it from the layer.\n\n![alt text](render-layers/image-3.png)\n\nHowever, if you remove the red guy from the stage and then add it back to the stage, it will not be added to the layer again.\n\n![alt text](render-layers/image-1.png)\n\nYou will need to reattach it to the layer yourself.\n\n![alt text](render-layers/image-2.png)\n\nThis may seem like a pain, but it's actually a good thing. It means that you have full control over the render order of the object, and you can change it at any time. It also means you can't accidentally add an object to a container and have it automatically re-attach to a layer that may or may not still be around - it would be quite confusing and lead to some very hard to debug bugs!\n\n#### **5. Layer Position in Scene Graph**\n\nThe layer’s position in the scene graph determines its render priority relative to other layers and objects.\n\n## ![alt text](render-layers/image-1.png)\n\n### **Complete Example**\n\nHere’s a real-world example that shows how to use RenderLayers to set ap player ui on top of the world.\n\n### **Gotchas and Things to Watch Out For**\n\n1. **Manual Reassignment**:\n\n- When an object is re-added to a logical parent, it does not automatically reassociate with its previous layer. Always reassign the object to the layer explicitly.\n\n2. **Nested Children**:\n\n- If you remove a parent container, all its children are automatically removed from layers. Be cautious with complex hierarchies.\n\n3. **Sorting Within Layers**:\n\n- Objects in a layer can be sorted dynamically using their `zIndex` property. This is useful for fine-grained control of render order.\n\n4. **Layer Overlap**:\n   - If multiple layers overlap, their order in the scene graph determines the render priority. Ensure the layering logic aligns with your desired visual output.\n\n### **Best Practices**\n\n1. **Group Strategically**: Minimize the number of layers to optimize performance.\n2. **Use for Visual Clarity**: Reserve layers for objects that need explicit control over render order.\n3. **Test Dynamic Changes**: Verify that adding, removing, or reassigning objects to layers behaves as expected in your specific scene setup.\n\nBy understanding and leveraging RenderLayers effectively, you can achieve precise control over your scene's visual presentation while maintaining a clean and logical hierarchy.",
  "code_samples": [
    {
      "code": "const redGuy = new PIXI.Sprite('red guy');\nredGuy.tint = 0xff0000;\n\nconst blueGuy = new PIXI.Sprite('blue guy');\nblueGuy.tint = 0x0000ff;\n\nstage.addChild(redGuy, blueGuy);",
      "language": "typescript"
    },
    {
      "code": "// a layer..\nconst layer = new RenderLayer();\nstage.addChild(layer);\nlayer.attach(redGuy);",
      "language": "typescript"
    },
    {
      "code": "|- stage\n    |-- redGuy\n    |-- blueGuy\n    |-- layer",
      "language": "unknown"
    },
    {
      "code": "|- stage\n    |-- blueGuy\n    |-- layer\n        |-- redGuy",
      "language": "unknown"
    },
    {
      "code": "layer.detach(redGuy); //  Stop rendering the rect via the layer",
      "language": "typescript"
    },
    {
      "code": "stage.removeChild(redGuy); // if the red guy was removed from the stage, it will also be removed from the layer",
      "language": "typescript"
    },
    {
      "code": "// add red guy to his original position\nstage.addChildAt(redGuy, 0);",
      "language": "typescript"
    },
    {
      "code": "layer.attach(redGuy); // re attach it to the layer again!",
      "language": "typescript"
    },
    {
      "code": "// reparent the layer to render first in the stage\nstage.addChildAt(layer, 0);",
      "language": "typescript"
    },
    {
      "code": "// description: This example demonstrates the use of RenderLayer to manage the rendering order of UI elements in a scene with multiple sprites and filters using PixiJS.\nimport {\n  Application,\n  Assets,\n  Container,\n  DisplacementFilter,\n  RenderLayer,\n  Sprite,\n  TilingSprite,\n} from 'pixi.js';\nimport { Fish } from './Fish';\n\n(async () => {\n  // Create a new application\n  const app = new Application();\n\n  // Initialize the application\n  await app.init({ width: 630, height: 410, antialias: true });\n\n  // Append the application canvas to the document body\n  document.body.appendChild(app.canvas);\n  // move the canvas to the center of the screen\n  app.canvas.style.position = 'absolute';\n  app.canvas.style.top = `${window.innerHeight / 2 - app.canvas.height / 2}px`;\n  app.canvas.style.left = `${window.innerWidth / 2 - app.canvas.width / 2}px`;\n\n  // Load textures\n  await Assets.load([\n    `https://pixijs.com/assets/pond/displacement_BG.jpg`,\n    `https://pixijs.com/assets/pond/overlay.png`,\n    `https://pixijs.com/assets/pond/displacement_map.png`,\n    `https://pixijs.com/assets/pond/displacement_fish1.png`,\n    `https://pixijs.com/assets/pond/displacement_fish2.png`,\n  ]);\n\n  const background = Sprite.from(\n    'https://pixijs.com/assets/pond/displacement_BG.jpg',\n  );\n\n  const pondContainer = new Container();\n\n  pondContainer.addChild(background);\n\n  app.stage.addChild(pondContainer);\n\n  const displacementMap = Assets.get(\n    'https://pixijs.com/assets/pond/displacement_map.png',\n  );\n\n  displacementMap.source.wrapMode = 'repeat';\n\n  const displacementSprite = Sprite.from(displacementMap);\n  const displacementFilter = new DisplacementFilter(displacementSprite, 40);\n\n  pondContainer.addChild(displacementSprite);\n  pondContainer.filters = [displacementFilter];\n\n  const uiLayer = new RenderLayer();\n\n  const fishes = [];\n\n  const names = [\n    'Alice',\n    'Bob',\n    'Caroline',\n    'David',\n    'Ellie',\n    'Frank',\n    'Gloria',\n    'Henry',\n    'Isabel',\n    'Jack',\n  ];\n  const textures = [\n    Assets.get('https://pixijs.com/assets/pond/displacement_fish1.png'),\n    Assets.get('https://pixijs.com/assets/pond/displacement_fish2.png'),\n  ];\n\n  for (let i = 0; i < 10; i++) {\n    const fish = new Fish(\n      names[i % names.length],\n      textures[i % textures.length],\n    );\n\n    fishes.push(fish);\n    pondContainer.addChild(fish);\n\n    fish.x = Math.random() * 630;\n    fish.y = Math.random() * 410;\n\n    uiLayer.attach(fish.ui);\n  }\n\n  const waterOverlay = TilingSprite.from(\n    Assets.get('https://pixijs.com/assets/pond/overlay.png'),\n  );\n\n  waterOverlay.width = 630;\n  waterOverlay.height = 410;\n\n  pondContainer.addChild(waterOverlay);\n\n  app.stage.addChild(uiLayer);\n\n  // Animate the mask\n  app.ticker.add(() => {\n    waterOverlay.tilePosition.x += 0.5;\n    waterOverlay.tilePosition.y += 0.5;\n\n    displacementSprite.x += 0.5;\n    displacementSprite.y += 0.5;\n\n    fishes.forEach((fish) => fish.update());\n  });\n})();",
      "language": "ts"
    },
    {
      "code": "import { Container, Sprite } from 'pixi.js';\nimport { CharacterUI } from './CharacterUI';\n\nexport class Fish extends Container {\n  ui;\n  _speed = 1 + Number(Math.random());\n  _direction = Math.random() * Math.PI * 2;\n  fishView;\n\n  constructor(name, texture) {\n    super();\n\n    this.fishView = new Sprite(texture);\n\n    this.fishView.anchor.set(0.5);\n\n    this.addChild(this.fishView);\n\n    this.ui = new CharacterUI(name, 20);\n    this.ui.y = 0;\n    this.addChild(this.ui);\n  }\n\n  update() {\n    this._direction += 0.001;\n\n    this.fishView.rotation = Math.PI - this._direction;\n    this.x += this._speed * Math.cos(-this._direction);\n    this.y += this._speed * Math.sin(-this._direction);\n\n    // wrap around the screen\n    const padding = 100;\n    const width = 630;\n    const height = 410;\n\n    if (this.x > width + padding) this.x -= width + padding * 2;\n    if (this.x < -padding) this.x += width + padding * 2;\n    if (this.y > height + padding) this.y -= height + padding * 2;\n    if (this.y < -padding) this.y += height + padding * 2;\n  }\n}",
      "language": "ts"
    },
    {
      "code": "import { Container, Graphics, Text } from 'pixi.js';\n\nexport class CharacterUI extends Container {\n  constructor(name) {\n    super();\n\n    const label = new Text({\n      text: name,\n      resolution: 2,\n      style: { fontSize: 16, fill: 0x000000 },\n      anchor: 0.5,\n    });\n\n    const padding = 10;\n\n    const bg = new Graphics()\n      .roundRect(\n        -label.width / 2 - padding,\n        -label.height / 2 - padding,\n        label.width + padding * 2,\n        label.height + padding * 2,\n        20,\n      )\n      .fill({\n        color: 0xffff00,\n        alpha: 1,\n      });\n\n    this.addChild(bg, label);\n  }\n}",
      "language": "ts"
    },
    {
      "code": "rect.zIndex = 10; // Higher values render later\n   layer.sortableChildren = true; // Enable sorting\n   layer.sortRenderLayerChildren(); // Apply the sorting",
      "language": "javascript"
    }
  ],
  "headings": [
    {
      "level": "h3",
      "text": "**Key Concepts**",
      "id": "**key-concepts**"
    },
    {
      "level": "h3",
      "text": "**Basic API Usage**",
      "id": "**basic-api-usage**"
    },
    {
      "level": "h2",
      "text": "![alt text](render-layers/image-1.png)",
      "id": "![alt-text](render-layers/image-1.png)"
    },
    {
      "level": "h3",
      "text": "**Complete Example**",
      "id": "**complete-example**"
    },
    {
      "level": "h3",
      "text": "**Gotchas and Things to Watch Out For**",
      "id": "**gotchas-and-things-to-watch-out-for**"
    },
    {
      "level": "h3",
      "text": "**Best Practices**",
      "id": "**best-practices**"
    },
    {
      "level": "h2",
      "text": "Render Loop",
      "id": "render-loop"
    }
  ],
  "url": "llms-txt#render-layers",
  "links": []
}